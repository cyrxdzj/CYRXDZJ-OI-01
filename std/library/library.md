## 内心深处的图书馆

![潜入我的内心深处](./card_018_008_normal_compressed.jpg)

### 题目描述

时间限制：3s（测试点 4~9 为 4s）

空间限制：1024MB

真冬发现了一座图书馆，里面有 $n$ 本书，编号是从 $1$ 到 $n$ 的正整数。

第 $i$ 本书有 $c_i$ 页，页码的编号是从 $1$ 到 $c_i$ 的正整数。

每一页书都有一个**难度值**，第 $j$ 页的**难度值**记为 $d_{i,j}$。

图书馆里的书太多了，一页一页看下去，不知道要看到什么时候。因此，每当真冬拿起一本书，她会随机地翻**一**页阅读，之后放下这本书。

每一页书的材质不同，因此每一页书被翻开的几率并不同。在翻第 $i$ 本书时，翻到第 $j$ 页的概率记为 $p_{i,j}$。保证对于所有的 $1\le i\le n$，都有 $\sum^{c_i}_{j=1} p_{i,j}=1$。换句话说，翻阅一本书，一定会恰好翻到某一页，所以，对于一本书，每一页被翻到的概率之和等于 $1$。这个概率不会随翻书的次数而改变，也不会受之前的翻书情况影响。

作为图书馆管理员，Miku 会收到 $m$ 条信息，信息种类有两种。

第一种信息是，真冬拜访了图书馆，并阅读了一些书。描述如下：

每次拜访图书馆，真冬有一个**头脑清醒度**，用正整数 $v$ 表示。她会选择阅读第 $l$ 到第 $r$ 本书。受个人状态影响，每次拜访，这三个参数可能不相同。

选择好后，她会按顺序阅读每本书。阅读方式如上文所示，对于每本书，她都会随机翻开一页（总计翻开 $r-l+1$ 页），如果她的**头脑清醒度**大于等于被翻到的页码的**难度值**，那么她就可以看懂这页书。**翻看这 $r-l+1$ 页书的过程中，她的头脑清醒度不会变化**。

**Miku 很关心真冬的学习情况，她希望知道，对于每一次拜访，真冬有多大的概率，翻开的所有 $r-l+1$ 页书都可以被真冬看懂**。但 Miku 不擅长算数，因此她想请你帮忙。每当收到这样的信息，都请你的程序输出这个概率。

第二种信息是，图书馆的某本书发生了改变。

真冬发现这座图书馆具有魔法，在某些时候，一本书会突然变成另一本新书。当然，眼尖的真冬看得出来。你的程序会知道详细情况，但你的程序应该不输出任何内容。这种信息的详细情况，请参见“输入数据格式”部分。

**本题中所有概率都需要使用逆元计算，模数统一为 $998244353$。**

### 输入数据格式

输入文件为 `library.in`。

第一行为一个正整数 $n$，代表书的数量。

接下来 $3n$ 行，每 $3$ 行代表一本书的信息。

第 $1$ 行，一个正整数 $c_i$，代表第 $i$ 本书的页数。

第 $2$ 行，一行 $c_i$ 个正整数，第 $j$ 个数记为 $d_{i,j}$，为一页书的难度。

第 $3$ 行，一行 $c_i$ 个正整数，第 $j$ 个数记为 $p_{i,j}$，为翻开这一页书的概率。模数为 $998244353$。

接下来一行只有一个正整数 $m$，代表消息的数量。每条消息有两种情况：

1. `1 l r v`，这代表真冬以 $v$ 的头脑清醒度，阅读了第 $l$ 到 $r$ 本书。

2. `2 x`，这代表第 $x$ 本书发生了更新，详细信息会在下方附上 $3$ 行内容表示：
   
   第 $1$ 行，一个正整数 $c_x$，代表新书的页数。
   
   第 $2$ 行，一行 $c_x$ 个正整数，第 $j$ 个数记为 $d_{x,j}$，为一页书的难度。
   
   第 $3$ 行，一行 $c_x$ 个正整数，第 $j$ 个数记为 $p_{x,j}$，为翻开这一页书的概率。模数为 $998244353$。
   
   可以发现这与上面的格式其实是一致的。

### 输出数据格式

对于每个消息 1，你都要输出一个非负整数，代表真冬看懂全部 $r-l+1$ 页书的概率。这个概率应该要用逆元计算，模数为 $998244353$。

### 样例

#### 样例输入 #1

```input1
3
3
1 3 5
598946612 199648871 199648871
3
2 3 6
748683265 623902721 623902721
2
5 7
665496236 332748118
6
1 1 2 3
1 1 3 4
1 1 3 7
2 2
3
1 2 4
443664157 221832079 332748118
1 1 2 3
1 2 3 5
```

#### 样例输出 #1

```output1
623902721
0
1
199648871
665496236
```

#### 样例解释 #1

书架上一共有 $3$ 本书。

| 书本编号 | 页数  | 第 1 页难度值 | 第 1 页概率       | 第 2 页难度值 | 第 2 页概率       | 第 3 页难度值 | 第 3 页概率       |
| ---- | --- | -------- | ------------- | -------- | ------------- | -------- | ------------- |
| 1    | $3$ | $1$      | $\frac{1}{5}$ | $3$      | $\frac{2}{5}$ | $5$      | $\frac{2}{5}$ |
| 2    | $3$ | $2$      | $\frac{1}{4}$ | $3$      | $\frac{3}{8}$ | $6$      | $\frac{3}{8}$ |
| 3    | $2$ | $5$      | $\frac{1}{3}$ | $7$      | $\frac{2}{3}$ |          |               |

之后有 3 次询问。

| $l$ | $r$ | $v$ | 答案            | 解释                                                  |
| --- | --- | --- | ------------- | --------------------------------------------------- |
| $1$ | $2$ | $3$ | $\frac{3}{8}$ | 有 $\frac{3}{5}$ 概率读懂第 1 本书，$\frac{5}{8}$ 概率读懂第 2 本书 |
| $1$ | $3$ | $4$ | $0$           | 不可能读懂第 $3$ 本书                                       |
| $1$ | $3$ | $7$ | $1$           | 无论怎么抽取，一定能读懂全部                                      |

接下来的修改，使得书本变成了：

| 书本编号   | 页数  | 第 1 页难度值 | 第 1 页概率       | 第 2 页难度值 | 第 2 页概率       | 第 3 页难度值 | 第 3 页概率       |
| ------ | --- | -------- | ------------- | -------- | ------------- | -------- | ------------- |
| 1      | $3$ | $1$      | $\frac{1}{5}$ | $3$      | $\frac{2}{5}$ | $5$      | $\frac{2}{5}$ |
| 2（已修改） | $3$ | $1$      | $\frac{1}{9}$ | $2$      | $\frac{5}{9}$ | $4$      | $\frac{1}{3}$ |
| 3      | $2$ | $5$      | $\frac{1}{3}$ | $7$      | $\frac{2}{3}$ |          |               |

之后有 2 次询问。

| $l$ | $r$ | $v$ | 答案            | 解释                                                  |
| --- | --- | --- | ------------- | --------------------------------------------------- |
| $1$ | $2$ | $3$ | $\frac{2}{5}$ | 有 $\frac{3}{5}$ 概率读懂第 1 本书，$\frac{2}{3}$ 概率读懂第 2 本书 |
| $2$ | $3$ | $5$ | $\frac{2}{3}$ | 一定能读懂第 1 本书，有 $\frac{2}{3}$ 概率读懂第 2 本书              |

### 数据范围与提示

友情提示，本题有点卡时间和空间。请尽可能降低常数。

虽然时空限制是 3s 1024MB，但在 oiClass 的环境中，开启 O2 优化的前提下，出题人的最优解可以跑到 1s 50MB 以内。可以尝试挑战一下。

为了方便你的调试，出题人提供了 `library_probability_calc.cpp`，你可以用它计算一个分数的逆元。

设一个测试点内所有书（包括初始的书和更新的书）的页码数总和为 $C$。

| 测试点编号 | $n$              | $m$              | $C$              | $v,d_{i,j},d_{x,j}$ | 更多特殊性质                       |
| ----- | ---------------- | ---------------- | ---------------- | ------------------- | ---------------------------- |
| 1~3   | $\le50$          | $\le100$         | $\le300$         | $\le10$             | 无                            |
| 4~5   | $\le5\times10^4$ | $\le3\times10^4$ | $\le1\times10^5$ | $\le10$             | 书本不会更新，你只会收到消息 1；$c_i\le2$   |
| 6~7   | $\le5\times10^4$ | $\le3\times10^4$ | $\le1\times10^5$ | $\le1\times10^5$    | 书本不会更新，你只会收到消息 1；$c_i\le2$   |
| 8~9   | $\le5\times10^4$ | $\le3\times10^4$ | $\le1\times10^5$ | $\le1\times10^9$    | 书本不会更新，你只会收到消息 1；$c_i\le2$   |
| 10~11 | $\le5\times10^4$ | $\le5\times10^4$ | $\le1\times10^5$ | $\le1\times10^9$    | 所有书本（包括初始的书和更新的书）都只有恰好 $1$ 页 |
| 12~13 | $\le5\times10^4$ | $\le5\times10^4$ | $\le4\times10^5$ | $\le1\times10^9$    | 对于所有消息 1，都有 $l=r$            |
| 14~17 | $\le5\times10^4$ | $\le5\times10^4$ | $\le4\times10^5$ | $\le1\times10^5$    | 无                            |
| 18~25 | $\le5\times10^4$ | $\le5\times10^4$ | $\le4\times10^5$ | $\le1\times10^9$    | 无                            |
| 样例1   | $\le50$          | $\le100$         | $\le300$         | $\le10$             | 符合测试点 1~3 的要求                |
| 样例2   | $\le50$          | $\le100$         | $\le300$         | $\le10$             | 符合测试点 1~3 的要求                |
| 样例3   | $\le5\times10^4$ | $\le3\times10^4$ | $\le1\times10^5$ | $\le1\times10^9$    | 符合测试点 6~7 的要求与特殊性质           |
| 样例4   | $\le5\times10^4$ | $\le5\times10^4$ | $\le4\times10^5$ | $\le1\times10^5$    | 符合测试点 14~17 的要求              |
| 样例5   | $\le5\times10^4$ | $\le5\times10^4$ | $\le4\times10^5$ | $\le1\times10^9$    | 符合测试点 18~25 的要求              |

对于所有测试点，都有 $1\le l\le r\le n\le5\times10^4$，$1\le m\le5\times10^4$，$n\le C\le4\times10^5$，$1\le v,d_{i,j},d_{x,j}\le1\times10^9$，$1\le p_{i,j},p_{x,j}<998244353$。

保证所有概率确实存在。出题人的数据生成程序会先指定概率的分子与分母，再计算逆元，而不是直接指定逆元结果。

### 版权信息

题目：[广州市铁一中学 邓子君](https://www.luogu.com.cn/user/387836)等，基于某题目改编

数据：[广州市铁一中学 邓子君](https://www.luogu.com.cn/user/387836)

题面部分内容的版权持有方为 `SEGA Corporation`，`Colorful Palette Inc.`，`Crypton Media Future Inc.`等公司，仅以非商业目的使用。

在 [CC-BY-NC 4.0](https://creativecommons.org/licenses/by-nc/4.0/legalcode.zh-hans) 协议下共享。
